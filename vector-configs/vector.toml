[api]
  enabled = true
  address = "[::]:8686"

[sources.fly_log_metrics]
  type = "internal_metrics"

[sources.nats]
  type = "nats"
  url = "nats://[${NETWORK-fdaa}::3]:4223"
  queue = "${QUEUE-}"
  subject = "${SUBJECT-logs.>}"
  auth.strategy = "user_password"
  auth.user_password.user = "${ORG-personal}"
  auth.user_password.password = "${ACCESS_TOKEN?}"
  connection_name = "Fly logs stream"

[transforms.log_json]
  type = "remap"
  inputs = ["nats"]
  source = '''
  . = parse_json!(.message)

  # If the message is a string and looks like JSON, try to parse it.
  # This is useful for apps that log in JSON format (like replica-rust).
  if exists(.message) && is_string(.message) && starts_with(.message, "{") {
    parsed, err = parse_json(.message)
    if err == null {
      # Merge the parsed fields into the root.
      . = merge(., parsed)

      # Map tracing-subscriber 'level' to OTel 'severity_text'
      if exists(.level) {
        .severity_text = .level
      }

      # Try to set a clean message field.
      # tracing-subscriber usually puts the message in fields.message.
      if exists(.fields.message) {
        .message = .fields.message
      } else if exists(.fields.line) {
        # replica-rust specifically uses 'line' in some places.
        .message = .fields.line
      }
    }
  }
  '''

[sinks.fly_log_metrics_prometheus]
  type = "prometheus_exporter" # required
  inputs = ["fly_log_metrics"] # required
  address = "[::]:9598" # required
  default_namespace = "fly-logs" # optional, no default

[sinks.blackhole]
  type = "blackhole"
  inputs = ["log_json"]
  print_interval_secs = 100000
